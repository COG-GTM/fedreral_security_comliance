"""
EY Demo: Vulnerability Detection and Fix Demonstration
=======================================================
This module demonstrates Devin's ability to detect security vulnerabilities
in existing code and automatically apply STIG-compliant fixes.

Each section shows:
1. VULNERABLE CODE (Before) - Common security anti-patterns
2. SECURE CODE (After) - STIG-compliant implementation
3. STIG/NIST mapping for compliance traceability
"""

import os
import sys

sys.path.insert(
    0, os.path.join(os.path.dirname(__file__), '..', '..', 'templates', 'python')
)

from security_utils import (  # noqa: E402
    InputValidator, InputSanitizer, ContentSecurityPolicy
)
from auth_manager import AuthenticationManager, PasswordPolicy  # noqa: E402
from audit_logger import AuditLogger  # noqa: E402


class VulnerabilityDemo:
    """
    Demonstrates vulnerability detection and remediation patterns.
    Each method pair shows vulnerable vs. secure implementations.
    """

    def __init__(self):
        self.auth_manager = AuthenticationManager()
        self.audit_logger = AuditLogger(log_dir="logs", app_name="vuln-demo")


class SQLInjectionDemo:
    """
    VULNERABILITY: SQL Injection (CWE-89)
    STIG: V-220632 - Input Sanitization
    NIST: SI-10 - Information Input Validation
    """

    @staticmethod
    def vulnerable_query(user_id: str) -> str:
        """
        VULNERABLE: String concatenation in SQL query
        Risk: Attacker can inject malicious SQL via user_id parameter
        Example attack: user_id = "1; DROP TABLE users;--"
        """
        query = f"SELECT * FROM users WHERE id = {user_id}"
        return query

    @staticmethod
    def secure_query(user_id: str) -> tuple:
        """
        SECURE: Parameterized query prevents SQL injection
        STIG V-220632 Compliance: Uses parameterized queries

        The database driver handles proper escaping and type conversion,
        ensuring user input cannot modify the query structure.
        """
        query = "SELECT * FROM users WHERE id = %s"
        params = (user_id,)
        return query, params

    @staticmethod
    def demonstrate():
        """Show the difference between vulnerable and secure queries"""
        malicious_input = "1; DROP TABLE users;--"

        print("=" * 60)
        print("SQL INJECTION VULNERABILITY DEMO")
        print("=" * 60)
        print(f"\nMalicious input: {malicious_input}")
        print(f"\nVULNERABLE query: {SQLInjectionDemo.vulnerable_query(malicious_input)}")

        secure_query, params = SQLInjectionDemo.secure_query(malicious_input)
        print(f"\nSECURE query: {secure_query}")
        print(f"Parameters: {params}")
        print("\nThe parameterized query treats the input as data, not code.")
        print("STIG V-220632 | NIST SI-10: Input sanitization applied")


class InputValidationDemo:
    """
    VULNERABILITY: Missing Input Validation (CWE-20)
    STIG: V-220631 - Input Validation
    NIST: SI-10 - Information Input Validation
    """

    @staticmethod
    def vulnerable_email_handler(email: str) -> dict:
        """
        VULNERABLE: No validation of email format
        Risk: Invalid data stored, potential injection attacks
        """
        return {"status": "success", "email": email}

    @staticmethod
    def secure_email_handler(email: str) -> dict:
        """
        SECURE: Whitelist validation using InputValidator
        STIG V-220631 Compliance: Validates format before processing
        """
        if not InputValidator.validate_email(email):
            return {"status": "error", "message": "Invalid email format"}

        sanitized_email = InputSanitizer.sanitize_string(email, max_length=255)
        if not sanitized_email:
            return {"status": "error", "message": "Invalid email"}

        return {"status": "success", "email": sanitized_email}

    @staticmethod
    def vulnerable_username_handler(username: str) -> dict:
        """
        VULNERABLE: No validation allows special characters
        Risk: XSS, injection attacks via username field
        """
        return {"status": "success", "username": username}

    @staticmethod
    def secure_username_handler(username: str) -> dict:
        """
        SECURE: Whitelist validation for username
        STIG V-220631 Compliance: Only alphanumeric, underscore, hyphen allowed
        """
        if not InputValidator.validate_username(username):
            return {
                "status": "error",
                "message": "Invalid username. Use 3-32 alphanumeric characters, underscore, or hyphen."
            }

        sanitized = InputSanitizer.sanitize_string(username, max_length=32)
        return {"status": "success", "username": sanitized}

    @staticmethod
    def demonstrate():
        """Show the difference between vulnerable and secure input handling"""
        test_cases = [
            ("valid@example.com", "Valid email"),
            ("<script>alert('xss')</script>@evil.com", "XSS attempt in email"),
            ("user'; DROP TABLE users;--", "SQL injection in username"),
            ("normal_user123", "Valid username"),
        ]

        print("\n" + "=" * 60)
        print("INPUT VALIDATION VULNERABILITY DEMO")
        print("=" * 60)

        for test_input, description in test_cases:
            print(f"\n--- {description} ---")
            print(f"Input: {test_input}")

            if "@" in test_input:
                vuln_result = InputValidationDemo.vulnerable_email_handler(test_input)
                secure_result = InputValidationDemo.secure_email_handler(test_input)
                print(f"VULNERABLE result: {vuln_result}")
                print(f"SECURE result: {secure_result}")
            else:
                vuln_result = InputValidationDemo.vulnerable_username_handler(test_input)
                secure_result = InputValidationDemo.secure_username_handler(test_input)
                print(f"VULNERABLE result: {vuln_result}")
                print(f"SECURE result: {secure_result}")

        print("\nSTIG V-220631 | NIST SI-10: Whitelist input validation applied")


class WeakPasswordDemo:
    """
    VULNERABILITY: Weak Password Storage (CWE-916)
    STIG: V-220629 - Authentication
    NIST: IA-5 - Authenticator Management
    """

    @staticmethod
    def vulnerable_password_check(password: str) -> dict:
        """
        VULNERABLE: No password policy enforcement
        Risk: Weak passwords easily cracked
        """
        if len(password) >= 4:
            return {"status": "success", "message": "Password accepted"}
        return {"status": "error", "message": "Password too short"}

    @staticmethod
    def secure_password_check(password: str) -> dict:
        """
        SECURE: STIG-compliant password policy
        STIG V-220629 Compliance:
        - Minimum 14 characters
        - Uppercase, lowercase, digit, special character required
        - Hashed with bcrypt (12 rounds)
        """
        is_valid, error_message = PasswordPolicy.validate_password(password)

        if not is_valid:
            return {"status": "error", "message": error_message}

        return {"status": "success", "message": "Password meets STIG requirements"}

    @staticmethod
    def demonstrate():
        """Show the difference between weak and strong password policies"""
        test_passwords = [
            ("pass", "Too short"),
            ("password123", "No uppercase/special"),
            ("Password123", "No special character"),
            ("SecureP@ssw0rd!", "Meets all requirements"),
            ("MyStr0ng!Password#2026", "Strong password"),
        ]

        print("\n" + "=" * 60)
        print("PASSWORD POLICY VULNERABILITY DEMO")
        print("=" * 60)
        print("\nSTIG V-220629 Requirements:")
        print(f"  - Minimum length: {PasswordPolicy.MIN_LENGTH} characters")
        print(f"  - Require uppercase: {PasswordPolicy.REQUIRE_UPPERCASE}")
        print(f"  - Require lowercase: {PasswordPolicy.REQUIRE_LOWERCASE}")
        print(f"  - Require digit: {PasswordPolicy.REQUIRE_DIGIT}")
        print(f"  - Require special: {PasswordPolicy.REQUIRE_SPECIAL}")

        for password, description in test_passwords:
            print(f"\n--- {description} ---")
            print(f"Password: {'*' * len(password)} ({len(password)} chars)")

            vuln_result = WeakPasswordDemo.vulnerable_password_check(password)
            secure_result = WeakPasswordDemo.secure_password_check(password)

            print(f"VULNERABLE check: {vuln_result['status']} - {vuln_result['message']}")
            print(f"SECURE check: {secure_result['status']} - {secure_result['message']}")

        print("\nSTIG V-220629 | NIST IA-5: Password policy enforcement applied")


class MissingSecurityHeadersDemo:
    """
    VULNERABILITY: Missing Security Headers (CWE-693)
    STIG: V-220641 - Security Headers
    NIST: SI-11 - Error Handling
    """

    @staticmethod
    def vulnerable_response() -> dict:
        """
        VULNERABLE: No security headers
        Risk: Clickjacking, XSS, MIME sniffing attacks
        """
        return {
            "headers": {},
            "body": {"data": "response"}
        }

    @staticmethod
    def secure_response() -> dict:
        """
        SECURE: All required security headers included
        STIG V-220641 Compliance: HSTS, X-Frame-Options, CSP, etc.
        """
        return {
            "headers": {
                "Strict-Transport-Security": "max-age=31536000; includeSubDomains",
                "X-Frame-Options": "DENY",
                "X-Content-Type-Options": "nosniff",
                "X-XSS-Protection": "1; mode=block",
                "Content-Security-Policy": ContentSecurityPolicy.get_policy(),
                "Referrer-Policy": "strict-origin-when-cross-origin",
                "Permissions-Policy": "geolocation=(), microphone=(), camera=()"
            },
            "body": {"data": "response"}
        }

    @staticmethod
    def demonstrate():
        """Show the difference between responses with and without security headers"""
        print("\n" + "=" * 60)
        print("SECURITY HEADERS VULNERABILITY DEMO")
        print("=" * 60)

        # Demonstrate both responses (vulnerable has no headers)
        _ = MissingSecurityHeadersDemo.vulnerable_response()  # noqa: F841
        secure_response = MissingSecurityHeadersDemo.secure_response()

        print("\nVULNERABLE response headers:")
        print("  (none)")

        print("\nSECURE response headers:")
        for header, value in secure_response["headers"].items():
            display_value = value[:50] + "..." if len(value) > 50 else value
            print(f"  {header}: {display_value}")

        print("\nSTIG V-220641 | NIST SI-11: Security headers applied")


class MissingAuditLoggingDemo:
    """
    VULNERABILITY: Missing Audit Logging (CWE-778)
    STIG: V-220635 - Audit Logging
    NIST: AU-2, AU-3 - Audit Events
    """

    @staticmethod
    def vulnerable_login(username: str, success: bool) -> dict:
        """
        VULNERABLE: No audit logging
        Risk: Cannot detect or investigate security incidents
        """
        if success:
            return {"status": "success"}
        return {"status": "error"}

    @staticmethod
    def secure_login(username: str, success: bool, ip_address: str, audit_logger: AuditLogger) -> dict:
        """
        SECURE: Comprehensive audit logging
        STIG V-220635 Compliance: Logs all authentication events
        """
        if success:
            audit_logger.log_authentication_success(
                user_id="demo-user-id",
                username=username,
                ip_address=ip_address,
                session_id="demo-session-id"
            )
            return {"status": "success"}
        else:
            audit_logger.log_authentication_failure(
                username=username,
                ip_address=ip_address,
                reason="invalid_credentials",
                attempt_number=1
            )
            return {"status": "error"}

    @staticmethod
    def demonstrate():
        """Show the difference between logging and non-logging implementations"""
        print("\n" + "=" * 60)
        print("AUDIT LOGGING VULNERABILITY DEMO")
        print("=" * 60)

        print("\nVULNERABLE implementation:")
        print("  - No logging of authentication attempts")
        print("  - Cannot detect brute force attacks")
        print("  - No audit trail for compliance")

        print("\nSECURE implementation logs:")
        print("  - Authentication success/failure")
        print("  - User ID, username, IP address")
        print("  - Timestamp with integrity hash")
        print("  - Session ID for correlation")

        print("\nExample audit log entry (JSON format):")
        example_entry = {
            "timestamp": "2026-01-14T00:51:00Z",
            "app_name": "ey-secure-api",
            "event_type": "authentication_failure",
            "severity": "WARNING",
            "user_id": "anonymous",
            "ip_address": "192.168.1.100",
            "details": {
                "username": "attacker",
                "reason": "invalid_credentials",
                "attempt_number": 3
            },
            "integrity_hash": "a1b2c3d4e5f6g7h8"
        }

        import json
        print(json.dumps(example_entry, indent=2))

        print("\nSTIG V-220635 | NIST AU-2, AU-3: Audit logging applied")


def run_all_demos():
    """Execute all vulnerability demonstrations"""
    print("\n" + "=" * 70)
    print("EY DEMO: AI-ASSISTED VULNERABILITY DETECTION AND REMEDIATION")
    print("=" * 70)
    print("\nThis demonstration shows how Devin automatically detects")
    print("security vulnerabilities and applies STIG-compliant fixes.")

    SQLInjectionDemo.demonstrate()
    InputValidationDemo.demonstrate()
    WeakPasswordDemo.demonstrate()
    MissingSecurityHeadersDemo.demonstrate()
    MissingAuditLoggingDemo.demonstrate()

    print("\n" + "=" * 70)
    print("SUMMARY: VULNERABILITIES DETECTED AND FIXED")
    print("=" * 70)
    print("""
    | Vulnerability              | STIG Control | NIST Control | Status |
    |----------------------------|--------------|--------------|--------|
    | SQL Injection              | V-220632     | SI-10        | FIXED  |
    | Missing Input Validation   | V-220631     | SI-10        | FIXED  |
    | Weak Password Policy       | V-220629     | IA-5         | FIXED  |
    | Missing Security Headers   | V-220641     | SI-11        | FIXED  |
    | Missing Audit Logging      | V-220635     | AU-2, AU-3   | FIXED  |
    """)
    print("All vulnerabilities have been remediated with STIG-compliant code.")
    print("=" * 70)


if __name__ == "__main__":
    run_all_demos()
